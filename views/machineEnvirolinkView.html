<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Monitoreo Ambiental</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Reset */
    * {margin:0; padding:0; box-sizing:border-box;}
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }

    /* Barra de navegaci√≥n superior */
    nav {
      background: #0f172a;
      padding: 0.8rem 2rem;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 2rem;
      justify-content: center;
    }
    nav a {
      color: #cbd5e1;
      text-decoration: none;
      font-weight: 500;
      transition: 0.3s;
    }
    nav a:hover, nav a.active {
      color: #38bdf8;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      color: white;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header h1 {
      font-size: 2rem;
      font-weight: 600;
    }

    /* Contenido principal */
    main {
      flex: 1;
      width: 100%;
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }

    /* Tarjetas */
    .card {
      background: white;
      width: 100%;
      height: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
    background: #3b82f6;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
    }
    .btn-primary:hover {
    background: #2563eb;
    }

    .btn-danger {
    background-color: #e74c3c;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
    }
        
    .btn-danger:hover {
    background-color: #c0392b;
    }

    .btn-success {
    background: #10b981;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
    margin-top: 1rem;
    }
    .btn-success:hover {
    background: #059669;
    }

    /* Tabla */
    .table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    }
    .table th, .table td {
    border: 1px solid #e2e8f0;
    padding: 0.6rem;
    text-align: center;
    }
    .table th {
    background: #f1f5f9;
    color: #1e293b;
    font-weight: 600;
    }

    
    /* Footer */
    footer {
      background: #0f172a;
      color: #94a3b8;
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
    }

    .chart-container {
      display: flex;
      width: 95%;
      height: 90%;
      margin-bottom: 20px;
    }

  </style>
</head>
<body>
  <!-- Barra de navegaci√≥n -->
  <nav>
    <ul>
      <li><a href="/" class="nav-link active" data-section="monitoreos-activos">Monitoreos Activos</a></li>
      <li><a href="/" class="nav-link" data-section="historico-monitoreos">Hist√≥rico de Monitoreos</a></li>
      <li><a href="/mapMonitoring" class="nav-link" data-section="mapa-monitoreos">Mapa de Monitoreos</a></li>
      <li><a href="/" class="nav-link" data-section="datos-almacenados">Datos Almacenados</a></li>
    </ul>
  </nav>

  <!-- Header -->
  <header>
    <h1>üå± Envirolink</h1>
  </header>

  <!-- Contenido principal -->
  <main id="mainContent">
    
    <h1 id="serialMachine"></h1>
    

    <div class="export-buttons" style="margin-bottom:20px ;">
        <button id="btnExportPDF" class="btn-danger">üìÑ Generar Informe PDF</button>
        <button id="btnExportCSV" class="btn-primary">üìä Exportar Datos CSV</button>
    </div>
    
    <!-- Contenedor para gr√°ficos -->
    <div id="chartsContainer"></div>

    <!--contenedor de graficos secundarios-->
    <div id="secondaryChartsContainer"></div>

    <!--tabla de datos-->
    <div id="cardTableContainer">
    

    </div>

    
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 EnviroLink ‚Äì Enlace ambiental en tiempo real</p>
  </footer>

  <script>
    //get if active session
    const activeSession = localStorage.getItem('sessionEnvirolink');
    if (!activeSession) {
        window.location.href = '/loginEnvirolink';
    }

    //get id station from url
    const urlParams = new URLSearchParams(window.location.search);
    const serialMachine = document.getElementById("serial");
    const stationId = urlParams.get('stationId');
    const typeParam = urlParams.get('type');
    const modelParam = urlParams.get('model');

    const mainContent = document.getElementById('mainContent');
    document.getElementById('btnExportPDF').addEventListener('click', generatePDFReport);
    document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
    //algoritmos para defodificar los datos del datalogger
    //get data from datalogger

    function thermo48i(lrecString) {
    // Expresi√≥n regular para extraer los valores
    const regex = /lrec\s+(\d+)\s+([\d:]+)\s+([\d-]+)\s+flags\s+([\w]+)\s+co\s+([-\d]+)\s+hico\s+([-\d]+)\s+intt\s+([\d.]+)\s+cht\s+([\d.]+)\s+pres\s+([\d.]+)\s+smplfl\s+([\d.]+)\s+speed\s+([\d.]+)\s+biasv\s+([-\d.]+)\s+intensity\s+([\d*]+)\s*sum\s+([\d]+)/;
    
    const match = lrecString.match(regex);
    
    if (!match) {
        throw new Error("Formato de cadena LREC no v√°lido");
    }
    
    // Extraer los valores usando grupos de captura
    const [
        fullMatch,
        lrec,
        time,
        date,
        flags,
        co,
        hico,
        intt,
        cht,
        pres,
        smplfl,
        speed,
        biasv,
        intensity,
        sum
    ] = match;

    
    // Convertir flags hexadecimal a binario para interpretaci√≥n
    const flagsBinary = parseInt(flags, 16).toString(2).padStart(32, '0');
    
    // Interpretar los flags (esto es un ejemplo, la interpretaci√≥n real depender√° del sistema)
    const systemOn = flagsBinary[0] === '1';
    const dataValid = flagsBinary[1] === '1';
    const calibrationMode = flagsBinary[2] === '1';
    
    // Retornar objeto con todos los datos decodificados
    return {
        lrec: parseInt(lrec),
        time: time,
        date: date,
        flags: {
            hex: flags,
            binary: flagsBinary,
            systemOn: systemOn,
            dataValid: dataValid,
            calibrationMode: calibrationMode
        },
        co: parseInt(co)/1000, // Convertir a ppm
        hico: parseInt(hico),
        intt: parseFloat(intt),
        cht: parseFloat(cht),
        pres: parseFloat(pres),
        smplfl: parseFloat(smplfl),
        speed: parseFloat(speed),
        biasv: parseFloat(biasv),
        intensity: intensity.replace('*', ''),
        sum: parseInt(sum)
    };
}


function thermo42c(lrecString) {
      if (typeof lrecString !== 'string') {
        throw new Error("El par√°metro debe ser una cadena de texto");
    }
    
    
    // Expresi√≥n regular mejorada
    const regex = /lrec\s+(\d+)\s+(\d+)\s+([\d:]+)\s+([\d-]+)\s+no\s+([\d.E+-]+)\s+nox\s+([\d.E+-]+)\s+ppb\s+flags\s+([a-f0-9]+)\s+pmtv\s+([-\d]+)\s+pmtt\s+([-\d.]+)(?:\s*intt\s+([\d.]+))?(?:\s*rctt\s+([\d.]+))?(?:\s*cnvt\s+([\d.]+))?(?:\s*pres\s+([\d.]+))?(?:\s*safl\s+([\d.]+))?(?:\s*ozfl\s+([\d.]+))?\s*sum\s+([a-f0-9]+)/i;
    
    const match = lrecString.match(regex);
    
    if (!match) {
        throw new Error("Formato de cadena LREC no v√°lido");
    }
    
    // Extraer los valores
    const [
        fullMatch,
        lrec,
        unknownField,
        time,
        date,
        no,
        nox,
        flags,
        pmtv,
        pmtt,
        intt,
        rctt,
        cnvt,
        pres,
        safl,
        ozfl,
        sum
    ] = match;
    
    // Convertir flags hexadecimal a binario
    const flagsBinary = parseInt(flags, 16).toString(2).padStart(32, '0');
    
    // Interpretaci√≥n b√°sica de flags
    const systemOn = flagsBinary[0] === '1';
    const dataValid = flagsBinary[1] === '1';
    const calibrationMode = flagsBinary[2] === '1';
    
    // Retornar objeto con todos los datos decodificados
    return {
        lrec: parseInt(lrec),
        unknownField: parseInt(unknownField),
        time: time,
        date: date,
        no: parseScientific(no),
        nox: parseScientific(nox),
        flags: {
            hex: flags,
            binary: flagsBinary,
            systemOn: systemOn,
            dataValid: dataValid,
            calibrationMode: calibrationMode
        },
        pmtv: parseInt(pmtv),
        pmtt: parseFloat(pmtt),
        intt: parseFloat(intt || '0'),
        rctt: parseFloat(rctt || '0'),
        cnvt: parseFloat(cnvt || '0'),
        pres: parseFloat(pres || '0'),
        safl: parseFloat(safl || '0'),
        ozfl: parseFloat(ozfl || '0'),
        sum: sum
    };
    }

    function parseScientific(value) {
    if (!value) return 0;
    if (value.includes('E') || value.includes('e')) {
        const [base, exponent] = value.split(/[Ee]/);
        return parseFloat(base) * Math.pow(10, parseInt(exponent));
    }
    return parseFloat(value);
  }

  // Funci√≥n para crear elementos DOM de forma segura
  function createElementFromHTML(htmlString) {
    const div = document.createElement('div');
    div.innerHTML = htmlString.trim();
    return div.firstChild;
  }

   // Funciones de exportaci√≥n
    async function generatePDFReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // T√≠tulo del informe
      doc.setFontSize(20);
      doc.text('Informe de Monitoreo Ambiental', 105, 15, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Estaci√≥n: ${urlParams.get('serial')}`, 15, 25);
      doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 15, 32);
      
      let yPosition = 45;
      
      // Agregar gr√°ficos al PDF
      for (const serial in chartInstances) {
        for (const parameter in chartInstances[serial]) {
          const chart = chartInstances[serial][parameter];
          
          // Convertir gr√°fico a imagen
          const chartCanvas = chart.canvas;
          const chartImage = await html2canvas(chartCanvas);
          const imgData = chartImage.toDataURL('image/png');
          
          // Agregar imagen al PDF
          if (yPosition > 250) {
            doc.addPage();
            yPosition = 15;
          }
          
          doc.setFontSize(14);
          doc.text(`Equipo ${serial} - ${parameter}`, 15, yPosition);
          yPosition += 10;
          
          doc.addImage(imgData, 'PNG', 15, yPosition, 180, 80);
          yPosition += 90;
        }
      }
      
      // Agregar tabla de datos si hay datos seleccionados
      const selectedSerial = document.getElementById('dataSelector').value;
      if (selectedSerial && allData[selectedSerial]) {
        if (yPosition > 150) {
          doc.addPage();
          yPosition = 15;
        }
        
        doc.setFontSize(14);
        doc.text(`Datos Detallados - Equipo ${selectedSerial}`, 15, yPosition);
        yPosition += 10;
        
        // Crear tabla en PDF
        const data = allData[selectedSerial];
        const headers = ['Fecha/Hora', ...Object.keys(data[0]).filter(key => key !== 'timestamp')];
        const rows = data.map(item => [
          item.timestamp,
          ...headers.slice(1).map(header => item[header] !== undefined ? item[header].toFixed(2) : '-')
        ]);
        
        doc.autoTable({
          startY: yPosition,
          head: [headers],
          body: rows,
          theme: 'grid',
          headStyles: { fillColor: [59, 130, 246] }
        });
      }
      
      // Guardar PDF
      doc.save(`Informe_Estacion_${document.getElementById('stationNumber').textContent}.pdf`);
    }

    

    let headerCsv = []
    let contentCsv = []

  function exportToCSV() {
      
      
      
      if (contentCsv.length === 0) {
        alert('No hay datos para exportar');
        return;
      }
      
      // Encabezados CSV
      const headers = headerCsv;
      let csvContent = headers.join(',') + '\n';
      
      // Datos CSV
      contentCsv.forEach(item => {
        const row = item
        csvContent += row.join(',') + '\n';
      });

      console.log("serialMachine", urlParams.get('serial'));
      
      // Crear enlace de descarga
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `Datos_Equipo_${urlParams.get('serial')}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function getDataLogger( idShow, serial, type, model) {
        console.log("Station ID:", idShow);
        console.log("Serial:", serial);
        console.log("Type:", type);
        console.log("Model:", model);

      //get last 100 data from datalogger
        console.log("Fetching data logger...");
        await fetch('/Envirolink/API/Devices/getDataControllerAll', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ idStation: idShow ,serial: serial})
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            if(type == 48 && model === "I"){
              let bufferCo = []
              let bufferintT = []
              let bufferInsity = []
              let bufferLabels = []

              for (let i = 0; i < data.msg.length; i++) {
                  const logger = data.msg[i];
                  try {
                      
                      const decodedData = thermo48i(logger.data);
                      console.log("Decoded Data:", decodedData);
                      bufferLabels.push(logger.createTime);
                      bufferCo.push(decodedData.co);
                      bufferintT.push(decodedData.intt);
                      bufferInsity.push(decodedData.intensity);

                  } catch (error) {
                      console.error(error.message);
                  }
              }

              

              // Crear un ID √∫nico para el gr√°fico
              const chartId = `chartCO-${serial}`;
              
              // Crear el contenedor para el gr√°fico
              const chartCard = createElementFromHTML(`
                <div class="card">
                  <h2>Datos de CO(ppm) - Equipo ${serial}</h2>
                  <div class="chart-container">
                    <canvas id="${chartId}" ></canvas>
                  </div>
                </div>
              `);
              
              // Agregar al contenedor de gr√°ficos
              document.getElementById('chartsContainer').appendChild(chartCard);
              
              // Crear el gr√°fico
              new Chart(document.getElementById(chartId), {
                type: 'line',
                data: {
                  labels: bufferLabels,
                  datasets: [{
                    label: "CO (ppm)",
                    data: bufferCo,
                    borderColor: "#3b82f6",
                    
                    tension: 0.3
                  },
                  {
                    label: "Temperatura Interna (¬∞C)",
                    data: bufferintT,
                    borderColor: "#f97316",
                    active:false,
                    tension: 0.3
                },
                  {
                    label: "Intensidad Hz",
                    data: bufferInsity,
                    borderColor: "#10b981",
                    active:false,
                    tension: 0.3
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales:{
                    x:{
                      ticks:{
                        autoSkip: true,
                        maxTicksLimit: 6
                      }
                    }
                  }
                }
              });

                headerCsv = ['Fecha', 'CO (ppm)', 'Flags', 'HiCO', 'IntT', 'CHT', 'Pres', 'SmplFl', 'Speed', 'BiasV', 'Intensity'];

              const tableCard = createElementFromHTML(`
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>CO (ppm)</th>
                        <th>Flags</th>
                        <th>HiCO</th>
                        <th>IntT</th>
                        <th>CHT</th>
                        <th>Pres</th>
                        <th>SmplFl</th>
                        <th>Speed</th>
                        <th>BiasV</th>
                        <th>Intensity</th>
                      </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                  </table>
              `);

                document.getElementById('cardTableContainer').appendChild(tableCard);
                const tableBody = document.getElementById('dataTableBody');
                for (let i = 0; i < data.msg.length; i++) {
                    const logger = data.msg[i];
                    try {
                        const decodedData = thermo48i(logger.data);
                        contentCsv.push([
                            logger.createTime.split(' ')[0],
                            decodedData.co.toFixed(2),
                            decodedData.flags.hex,
                            decodedData.hico,
                            decodedData.intt.toFixed(2),
                            decodedData.cht.toFixed(2),
                            decodedData.pres.toFixed(2),
                            decodedData.smplfl.toFixed(2),
                            decodedData.speed.toFixed(2),
                            decodedData.biasv.toFixed(2),
                            decodedData.intensity
                        ]);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${logger.createTime.split(' ')[0]}</td>
                            <td>${decodedData.co}</td>
                            <td>${decodedData.flags.hex}</td>
                            <td>${decodedData.hico}</td>
                            <td>${decodedData.intt}</td>
                            <td>${decodedData.cht}</td>
                            <td>${decodedData.pres}</td>
                            <td>${decodedData.smplfl}</td>
                            <td>${decodedData.speed}</td>
                            <td>${decodedData.biasv}</td>
                            <td>${decodedData.intensity}</td>
                        `;
                        tableBody.appendChild(row);
                    } catch (error) {
                        console.error(error.message);
                    }
                }

            }
            
            if(type == 42 && model === "C"){
              let bufferNo = []
              let bufferNox = []
              let bufferintT = []
              let bufferConvertT = []
              let bufferPMTT = []
              let bufferLabels = []
              for (let i = 0; i < data.msg.length; i++) {
                  const logger = data.msg[i];
                  try {
                      const decodedData = thermo42c(logger.data);
                      console.log("Decoded Data:", decodedData);
                      bufferLabels.push(logger.createTime);
                      bufferNo.push(decodedData.no);
                      bufferNox.push(decodedData.nox);
                      bufferintT.push(decodedData.intt);
                      bufferConvertT.push(decodedData.cnvt);
                      bufferPMTT.push(decodedData.pmtt);

                  } catch (error) {
                      console.error(error.message);
                  }
              }

              // Crear un ID √∫nico para el gr√°fico
              const chartId = `chartNO-${serial}`;
              
              // Crear el contenedor para el gr√°fico
              const chartCard = createElementFromHTML(`
                <div class="card">
                  <h2>Datos de NO y NOx - Equipo ${serial}</h2>
                  <div class="chart-container">
                    <canvas id="${chartId}"></canvas>
                  </div>
                </div>
              `);
              
              // Agregar al contenedor de gr√°ficos
              document.getElementById('chartsContainer').appendChild(chartCard);

              // Crear el gr√°fico
              new Chart(document.getElementById(chartId), {
                type: 'line',
                data: {
                  labels: bufferLabels,
                  datasets: [{
                    label: 'NO PPB',
                    data: bufferNo,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    tension: 0.3,
                    
                  },{
                    label: 'NOx PPB',
                    data: bufferNox,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    tension: 0.3
                  },
                  {
                    label: 'Temperatura Interna (¬∞C)',
                    data: bufferintT,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1,
                    tension: 0.3
                  },
                  {
                    label: 'Temperatura de Conversi√≥n (¬∞C)',
                    data: bufferConvertT,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    tension: 0.3
                  },
                  {
                    label: 'PMTT',
                    data: bufferPMTT,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    tension: 0.3
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales:{
                    x:{
                      ticks:{
                        autoSkip: true,
                        maxTicksLimit: 6
                      }
                    }
                  }
                }
              });

                const tableCard = createElementFromHTML(`
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>NO (PPB)</th>
                            <th>NOx (PPB)</th>
                            <th>Flags</th>
                            <th>PMTV</th>
                            <th>PMTT</th>
                            <th>IntT</th>
                            <th>RCTT</th>
                            <th>CNVT</th>
                            <th>Pres</th>
                            <th>SAFL</th>
                            <th>OZFL</th>
                        </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                `);
    
                    document.getElementById('cardTableContainer').appendChild(tableCard);
                    const tableBody = document.getElementById('dataTableBody');
                    for (let i = 0; i < data.msg.length; i++) {
                        const logger = data.msg[i];
                        try {
                            const decodedData = thermo42c(logger.data);
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${logger.createTime.split(' ')[0]}</td>
                                <td>${decodedData.no.toFixed(2)}</td>
                                <td>${decodedData.nox.toFixed(2)}</td>
                                <td>${decodedData.flags.hex}</td>
                                <td>${decodedData.pmtv}</td>
                                <td>${decodedData.pmtt}</td>
                                <td>${decodedData.intt}</td>
                                <td>${decodedData.rctt}</td>
                                <td>${decodedData.cnvt}</td>
                                <td>${decodedData.pres}</td>
                                <td>${decodedData.safl}</td>
                                <td>${decodedData.ozfl}</td>
                            `;
                            tableBody.appendChild(row);
                        } catch (error) {
                            console.error(error.message);
                        }
                    }   

            }
        }).catch(error => {
            console.error("Error fetching data logger:", error);
        });
    }



    

    if (!stationId) {
        console.error("Controller ID not found in URL");
    } else {
        //get data controller from api
        getDataLogger( stationId, urlParams.get('serial'), typeParam, modelParam);

    }

    
    

    
  </script>
</body>
</html>